---
title: "HPV Vaccine Hesitancy Buea - Cameroon"
author: "Valirie N. Agbor"
date: "`r Sys.Date()`"
output: html_document
---


# Workflow 

1. Import packages and import data 
2. Explore and clean data - taking note of variables with missing observations (Done)
3. Determine the number of participants included at baseline and perform exclusions (Done)
4. Explore variations in levels of physical activity by sex and area (Done)
5. Create Table 1 (Adjust means and proportions using direct standardisation) (Done)
6. Perform univariate survival analyses (Done)
7. Perform multivariable cox regression analysis (All done)
   - Modelling and variable selection
   - Consider performing age-sex-specific analysis 
   - Assessing model assumption 
8. Perform subgroup analyses 
9. Perform sensitivity analyses 



# Import packages and read data 

```{r Import packages and data}

rm (list=ls())

#Loading required packages---
pacman::p_load(
  qvcalc, 
  broom, tidyverse, purrr, stringr, janitor, skimr, 
  compareGroups, Hmisc, DirectStandardisation,
  Jasper, ggplot2, gridExtra)

#loading baseline data---
folder.dir <- "C:/Users/Valirie N. Agbor/OneDrive/Ongoing projects/HPV vaccine hesitancy"
df <- read_csv(paste0(folder.dir, "/", "HPV vaccine hesitancy.csv"), col_types=cols())

knitr::opts_chunk$set(echo = FALSE)
```

# Data exploration ---

In total, `nrow(df)` participants were included in the study. 

```{r}

# Filter missing first row 
df_clean <- slice(df, -1) %>% clean_names()

original_names <- names(df_clean)

# Rename headings --- 
df_clean <- rename(
  df_clean, 
  education="highest_level_of_education", 
  h_income="monthly_household_income_in_frs", 
  n_child="number_of_children", 
  gender_child="gender_of_child_children", 
  n_child_18="number_of_children_18_years", 
  heard_of_cc="have_you_heard_of_cervical_cancer", 
  is_cc_severe="do_you_believe_cervical_cancer_is_a_severe_disease", 
  heard_of_hpv="have_you_heard_of_human_papillomavirus_hpv", 
  hpv_causes_cc="did_you_know_that_hpv_causes_cervical_cancer", 
  knows_cc_vax_exist="did_you_know_there_is_a_vaccine_to_prevent_cervical_cancer", 
  knows_where_get_hpvvax="do_you_know_where_to_get_the_hpv_vaccine", 
  has_hpvvax_child="has_your_child_taken_the_hpv_vaccine", 
  accept_hpvvax_for_child="if_no_would_you_agree_to_have_your_children_vaccinated_against_hpv" , 
  barriers_to_accept="if_no_or_not_sure_which_of_these_prevents_you_from_vaccinating_your_child_tick_all_that_apply", 
  child_vax_others="has_your_child_ren_taken_any_other_vaccines", 
  chronic_d="any_history_of_chronic_disease", 
  parent_vax_any="to_your_knowledge_have_you_received_any_vaccines_for_yourself", 
  child_recommended_vax="has_any_of_your_children_received_any_recommended_vaccines", 
  knows_cc_case="do_you_know_anyone_who_has_had_cervical_cancer", 
  thinks_vax_safe="do_you_think_the_vaccine_will_be_safe_for_your_children", 
  concern_adverse_rx="are_you_concerned_that_your_child_may_develop_severe_adverse_reactions_to_the_hpv_vaccine", 
  leaders_support_vax="do_you_think_leaders_religious_or_political_leaders_teachers_in_your_community_will_support_hpv_vaccinations_for_children", 
  other_parents_vax="do_you_think_most_parents_around_you_have_vaccinated_their_children_against_hpv_or_will_consider_vaccinating_their_children_against_hpv",
  trust_moh="the_cameroon_ministry_of_health_is_responsible_for_providing_these_vaccines_for_female_children_do_you_trust_that_the_ministry_of_health_is_concerned_about_the_health_of_the_population", 
  trust_vax_comps="do_you_trust_the_companies_making_the_hpv_vaccine", 
  received_badinfo="have_you_heard_anything_bad_about_the_hpv_vaccine", 
  state_badinfo="if_yes_please_state")

```

## Explore missing data -- 

```{r}
# skim(df_clean)
#map(.x = df_clean %>% select(-1), class)
```

## Recode variables -- 

```{r}

df_clean <- 
  df_clean %>% 
  select(-timestamp) %>% 
  mutate(
    gender=factor(gender),
    health_area=factor(case_when(health_area=="Mira" ~ "Muea", TRUE ~ health_area)),
    education=case_when(
      education=="No formal education" ~ "No formal", 
      education=="Post-secondary/Technical" ~ "Post-secondary", 
      education=="Tertiary/University/Professional designation" ~ "Tertiary",
      TRUE ~ education),
    religion=case_when(
      religion=="Pentacostal" | religion=="Pentecostal" ~ "Pentecostal", 
      religion=="Bahai" | religion=="Islam" ~ "Islam", 
      TRUE ~ religion),
    employment_status=case_when(employment_status=="Umemployed" ~ "Unemployed", TRUE ~ employment_status), 
    employment_status=case_when(
      employment_status=="Employed (agricultural work)" ~ "Employed (manual)", 
      employment_status=="Retired" | employment_status=="House wife" | employment_status=="Student" ~ "Unemployed",
      TRUE ~ employment_status),
    h_income=case_when(h_income=="200,000 - <250,000" | h_income=="≥250,000" ~ "≥200,000", TRUE ~ h_income),
    is_cc_severe=case_when(heard_of_cc=="No" ~ "Never heard of CC", TRUE ~ is_cc_severe), 
    hpv_causes_cc=case_when(heard_of_hpv=="No" ~ "Never heard of HPV", TRUE ~ hpv_causes_cc),
    knows_cc_vax_exist=case_when(heard_of_hpv=="No" & heard_of_cc=="No" ~ "Never heard of HPV or CC", TRUE ~ knows_cc_vax_exist), 
    hesitancy=case_when(has_hpvvax_child!="Yes" & accept_hpvvax_for_child!="Yes" ~ "Yes", TRUE ~ "No"))

df_clean %>% mutate(across(where(is.character), ~as.factor(.x)))

# Imput missing data -- 
df_clean <- mutate(
  df_clean, 
  gender=case_when(is.na(gender) ~ "Female", TRUE ~ gender), 
  marital_status=case_when(is.na(marital_status) ~ "Married", TRUE ~ marital_status), 
  education=case_when(is.na(education) ~ "Tertiary", TRUE ~ education), 
  religion=case_when(is.na(religion) ~ "Pentecostal", TRUE ~ religion),
  employment_status=case_when(is.na(employment_status)~"Employed (nonmanual)", TRUE~employment_status),
  heard_of_hpv=factor(case_when(is.na(heard_of_hpv) ~ "Yes", TRUE ~ heard_of_hpv)),
  heard_of_cc=factor(heard_of_cc),
  hpv_causes_cc=case_when(is.na(hpv_causes_cc) ~ "Never heard of HPV", TRUE ~ hpv_causes_cc),
  knows_where_get_hpvvax=case_when(is.na(knows_where_get_hpvvax) ~ "No", TRUE ~ knows_where_get_hpvvax), 
  has_hpvvax_child=case_when(is.na(has_hpvvax_child) ~ "No", TRUE ~ has_hpvvax_child), 
  child_vax_others=case_when(is.na(child_vax_others) ~ "Yes", TRUE ~ child_vax_others), 
  chronic_d=case_when(is.na(chronic_d) ~ "No", TRUE ~ chronic_d), 
  parent_vax_any=case_when(is.na(parent_vax_any) ~ "Yes", TRUE ~ parent_vax_any), 
  concern_adverse_rx=case_when(is.na(concern_adverse_rx) ~ "Yes", TRUE ~ concern_adverse_rx), 
  trust_moh=case_when(is.na(trust_moh) ~ "Yes", TRUE ~ trust_moh)
  )


# Convert variables to factors -- 
df_clean <- mutate(
  df_clean, 
  heard_of_hpv=factor(heard_of_hpv), 
  heard_of_cc=factor(heard_of_cc)
)
```


# Descriptive analysis --- 

## Sociodemographic
**Variables:** 
`age_years`, 
`gender`, 
`marital_status`,
`religion`,
`h_income`,
`n_child`,
`n_child_18`,
`gender_child`

Summarise data and explore their association with hesitancy. 


```{r Descriptive Table 1}

df_table <- mutate(
  df_clean, 
  age_years=case_when(age_years<20~20, TRUE~age_years), #Record the age observations with ages<19 years
  age10=factor(case_when(
    age_years<30~"20-29", 
    age_years>=30 & age_years<40~"30-39", 
    age_years>=40 & age_years<50~"40-49",
    age_years>=50 & age_years<60~"50-59",
    age_years>=60~"60+")))

require(Hmisc)

## Set appropriate variable labels before tabulations

n_var <- c("age10", "age_years", "health_area", "gender", "education", 
           "marital_status", "employment_status", "h_income", "religion",
           "n_child", "n_child_18", "gender_child")


l_var <- c("Age group, year", "Age, mean (SD), year", "Health area", "Gender", "Level of education", 
           "Marital status", "Employment status", "Monthly household income, FCFA", "Religion",
           "Number of children, median (IQR)", "Number of children < 18 years, median (IQR)", "Child's gender")

desc_table <- select(df_table, all_of(n_var)) 

for (i in seq_along(n_var)) {
  Hmisc::label(desc_table) <- l_var[[i]]
}

tab <- descrTable(desc_table)

# Extract tables into excel
export2xls(tab, file = "Table 1 - xtics of participants.xlsx")

# Get median values for number of child 
median(desc_table$n_child);quantile(df_table$n_child, probs=c(0.25, 0.75))
median(desc_table$n_child_18);quantile(df_table$n_child_18, probs=c(0.25, 0.75))


detach("package:Hmisc", unload = TRUE)

```


# Section 2: Awareness of HPV and cervical cancer ---

**Objective 1:** Level of awareness of HPV and cervical cancer.
**Objective 2:** Socioeconomic inequalities in the level of awareness of HPV and cervical cancer by 
age, 
sex, 
marital status, 
education, 
income, 
religion, and 
gender of the child


## Descriptive table 
Means and proportions will be stratified by age, sex, and health area

```{r}

function.dir <- "C:/Users/Valirie N. Agbor/OneDrive/Ongoing projects/HPV vaccine hesitancy/HPV_vaccine_hesitancy/Custom_functions_epidemiology/R/"

source(paste0(function.dir, "make_standardised_baseline_ckb_data.R"))
source(paste0(function.dir, "df_transpose.R"))
source(paste0(function.dir, "make_quartile_var_labels.R"))


# Standardise numeric variables ------
# num_vars <- c("age10")
# num_labels <- c("Age, mean (SD), year")

# List of categorical variables ---
cat_vars <- c("education", "marital_status", "employment_status", "h_income", "gender_child")

cat_var_labels <- c("Level of education", "Marital status", "Employment status", 
                    "Monthly household income, FCFA", "Child's gender")

# Adjustment 
adjust_vars <- c("age10", "gender", "health_area")
main_expo <- c("heard_of_hpv", "heard_of_cc")

# Checkpoint
# stopifnot(length(num_vars)==length(num_labels)) 
stopifnot(length(cat_vars)==length(cat_var_labels)) 


# Standardise categorical variables ---
df_aware <- map(
  .x=main_expo, 
  ~make_standardised_ckb_data(
     dataset=df_table %>% 
       select(all_of(c(cat_vars, adjust_vars, main_expo))) %>% 
       na.omit(.), 
     categorical_vars=cat_vars, 
     main_exposure=.x, 
     adjustment_variables=adjust_vars))    

# Standardise age ---
df_aware_age <- map(
  .x=main_expo, 
  ~make_standardised_ckb_data(
     dataset=df_table %>% 
       select(age_years, all_of(c(cat_vars, adjust_vars, main_expo))) %>% 
       na.omit(.), 
     numeric_vars="age_years",
     numeric_vars_labels="Age, mean (SD), years",
     categorical_vars="age10", 
     main_exposure=.x, 
     adjustment_variables=c("gender", "health_area")) %>% 
  mutate(
    exposure=stringr::str_replace_all(
      string=exposure, 
      pattern="\\.", 
      replacement="-"
    )
  )
)


df_aware <- map2(.x=df_aware, .y=df_aware_age, rbind)

# Gender --- 
df_aware_gender <- map(
  .x=main_expo, 
  ~make_standardised_ckb_data(
     dataset=df_table %>% select(all_of(c(cat_vars, adjust_vars, main_expo))) %>% na.omit(.), 
     categorical_vars="gender", # best left unlabelled
     main_exposure=.x, 
     adjustment_variables=c("age10", "health_area"))) 

df_aware <- map2(.x=df_aware, .y=df_aware_gender, rbind)

# Health area --- 
df_aware_area <- map(
  .x=main_expo, 
  ~make_standardised_ckb_data(
     dataset=df_table %>% select(all_of(c(cat_vars, adjust_vars, main_expo))) %>% na.omit(.), 
     categorical_vars="health_area", # best left unlabelled
     main_exposure=.x, 
     adjustment_variables=c("age10", "gender"))) 

df_aware <- map2(.x=df_aware, .y=df_aware_area, rbind)

# Rename and reorder characteristics 

df_xtics_labels <- 
  data.frame(
    exposure=c(
      "Age, mean (SD), years", 
      "age10_20-29", 
      "age10_30-39", 
      "age10_40-49", 
      "age10_50-59", 
      "age10_60-",
      "gender_Female", 
      "gender_Male",
      "health_area_Bokwango", 
      "health_area_Bueatown", 
      "health_area_Molyko",
      "health_area_Muea",
      "education_No.formal", 
      "education_Primary",
      "education_Secondary",
      "education_Post.secondary", 
      "education_Tertiary",
      "marital_status_Single", 
      "marital_status_Married", 
      "marital_status_Divorced", 
      "marital_status_Cohabitation",
      "marital_status_Widow.Widower",
      "employment_status_Unemployed",
      "employment_status_Employed..nonmanual.",
      "employment_status_Employed..manual.",
      "h_income_.50.000", 
      "h_income_50.000....100.000",
      "h_income_100.000....150.000",
      "h_income_150.000....200.000",
      "h_income_.200.000", 
      "gender_child_Both",
      "gender_child_Female", 
      "gender_child_Male"), 
    
    xtics_lab=c(
      "Age, mean (SD), years", 
      "20-29", 
      "30-39", 
      "40-49", 
      "50-59", 
      "60+",
      "Female", 
      "Male",
      "Bokwango", 
      "Bueatown", 
      "Molyko",
      "Muea",
      "No formal", 
      "Primary",
      "Secondary",
      "Post secondary", 
      "Tertiary",
      "Single", 
      "Married", 
      "Divorced", 
      "Cohabitation",
      "Widow or widower",
      "Unemployed",
      "Employed (nonmanual)",
      "Employed (manual)",
      "<50.000", 
      "50.000 to <100.000",
      "100.000 to <150.000",
      "150.000 to <200.000",
      ">=200.000", 
      "Both",
      "Female", 
      "Male"),
    
    stringsAsFactors = FALSE
  ) 

if(length(df_xtics_labels$exposure)!=length(df_xtics_labels$xtics_lab)) stop("Unequal variable lengths")


df_xtics_labels$order_var <- seq_len( nrow(df_xtics_labels) )


# Make table ---
map_dfc(
  .x=df_aware, 
  ~merge(df_xtics_labels, .x, by="exposure", all=TRUE) %>% 
    arrange(order_var) %>% 
    select(-c(exposure, order_var))) %>% 
  write.csv(file="Table 2 - Demo and SES by CC and HPV awareness.csv")

# Bind area data to main dataset --
# df_table1 <- map2(
#   .x=df_table1, 
#   .y=df_table1_area, 
#   ~rbind(.x, .y$area))

```

## Inferential analysis -- 

```{r}



```

